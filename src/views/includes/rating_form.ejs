<form id="ratingForm" action="/submit-rating" method="POST">
    <input type="hidden" id="ratingForm_User_id" value="<% user %>">
    <input type="hidden" id="ratingForm_Book_id" value="<% book._id %>">
    <div id="starContainer" >
        <i class='d-inline bx bx-star bx-md' data-value="1"></i>
        <i class='d-inline bx bx-star bx-md' data-value="2"></i>
        <i class='d-inline bx bx-star bx-md' data-value="3"></i>
        <i class='d-inline bx bx-star bx-md' data-value="4"></i>
        <i class='d-inline bx bx-star bx-md' data-value="5"></i>
    </div>
    <input type="hidden" name="rating" id="ratingInput" value="<%= typeof review == 'undefined' ? '0' : review.rating %>">
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
 
        const starContainer = document.getElementById('starContainer');
        const stars = starContainer.querySelectorAll('.bx');
        const ratingInput = document.getElementById('ratingInput');
        const ratingForm = document.getElementById('ratingForm');

        function highlightStars(value) {
            stars.forEach(star => {
                if (star.getAttribute('data-value') <= value) {
                    star.classList.remove('bx-star');
                    star.classList.add('bxs-star');
                } else {
                    star.classList.remove('bxs-star');
                    star.classList.add('bx-star');
                }
            });
        }
        highlightStars(ratingInput.getAttribute('value'));
        stars.forEach(star => {
            star.addEventListener('mouseover', function () {
                const value = this.getAttribute('data-value');
                highlightStars(value);
            });

            star.addEventListener('mouseout', function () {
                const value = ratingInput.getAttribute('value');
                highlightStars(value);
            });

            star.addEventListener('click', function () {
                const value = this.getAttribute('data-value');
                ratingInput.value = value;
                highlightStars(value);
                ratingForm.submit();
            });
        });
        
        starContainer.addEventListener('click', async (event) => {
        if (event.target.classList.contains('bx')) {
            const rating = event.target.getAttribute('data-value');
            ratingInput.value = rating;


            // Automatically submit the form
            const user_id = document.getElementById('ratingForm_User_id').value;
            const book_id = document.getElementById('ratingForm_Book_id').value;

            try {
            const response = await fetch('/submit-rating', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user: user_id, book: book_id, rating }),
            });

            if (!response.ok) {
                const errorDetails = await response.json();
                console.error('Error submitting rating:', errorDetails);
                throw new Error(errorDetails.message || 'Failed to submit rating.');
            }

            messageContainer.innerHTML = '<p class="text-success">Rating submitted successfully!</p>';
            } catch (error) {
            messageContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
            }
        }
        });
    });
</script>